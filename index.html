<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>FOB Mathhammer</title>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="main.css">
  </head>

  <body>
    <script src="//cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>

    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g="
      crossorigin="anonymous"></script>
    <script src="http://d3js.org/d3.v4.min.js"></script>


    <div class="form-group">
      <label for="num-attacks">Number of attacks</label>
      <input class="form-control" type="number" id="num-attacks" min="1" value="1">
    </div>

    <h4>Hitting</h4>

    <div class="form-group">
      <label for="to-hit">To Hit roll</label>
      <select class="form-control" id="tohit">
        <option value="2">2+</option>
        <option value="3" selected>3+</option>
        <option value="4">4+</option>
        <option value="5">5+</option>
        <option value="6">6+</option>
      </select>
    </div>

    <div class="form-group">
      <label class="radio-inline">
        <input type="radio" name="tohit-mod" id="tohit-mod-none" checked> No modifier
      </label>

      <label class="radio-inline">
        <input type="radio" name="tohit-mod" id="tohit-mod-rerollones">
        Re-roll 1s to hit
      </label>

      <label class="radio-inline">
        <input type="radio" name="tohit-mod" id="tohit-mod-rerollall">
        Re-roll to hit
      </label>
    </div>

    <h4>Wounding</h4>

    <div class="form-group">
      <label for="strength">Strength</label>
      <select class="form-control" id="strength">
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option selected>4</option>
        <option>5</option>
        <option>6</option>
        <option>7</option>
        <option>8</option>
        <option>9</option>
        <option>10</option>
      </select>
    </div>

    <div class="form-group">
      <label for="toughness">Toughness</label>
      <select class="form-control" id="toughness">
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option selected>4</option>
        <option>5</option>
        <option>6</option>
        <option>7</option>
        <option>8</option>
        <option>9</option>
        <option>10</option>
      </select>
    </div>

    <div class="form-group">
      <label class="radio-inline">
        <input type="radio" name="towound-mod" id="towound-mod-none" checked> No modifier
      </label>

      <label class="radio-inline">
        <input type="radio" name="towound-mod" id="towound-mod-rerollones">
        Re-roll 1s to wound
      </label>

      <label class="radio-inline">
        <input type="radio" name="towound-mod" id="towound-mod-rerollall">
        Re-roll to wound
      </label>
    </div>

    <h4>Saves</h4>

    <div class="form-group">
      <label for="armour">Armour Save</label>
      <select class="form-control" id="armour">
        <option value="2">2+</option>
        <option value="3" selected>3+</option>
        <option value="4">4+</option>
        <option value="5">5+</option>
        <option value="6">6+</option>
        <option value="7">None</option>
      </select>
    </div>

    <div class="form-group">
      <label for="ap">AP</label>
      <select class="form-control" id="ap">
        <option>-4</option>
        <option>-3</option>
        <option>-2</option>
        <option>-1</option>
        <option selected>0</option>
        <option>+1</option>
      </select>
    </div>

    <div class="form-group">
      <label for="invulnerable">Invulnerable Save</label>
      <select class="form-control" id="invulnerable">
        <option value="2">2+</option>
        <option value="3">3+</option>
        <option value="4">4+</option>
        <option value="5">5+</option>
        <option value="6">6+</option>
        <option value="7" selected>None</option>
      </select>
    </div>

    <div class="form-group">
      <label class="radio-inline">
        <input type="radio" name="invulnerable-mod" id="invulnerable-mod-none" checked> No modifier
      </label>

      <label class="radio-inline">
        <input type="radio" name="invulnerable-mod" id="invulnerable-mod-rerollones">
        Re-roll invulnerable saves of 1
      </label>

      <label class="radio-inline">
        <input type="radio" name="invulnerable-mod" id="invulnerable-mod-rerollall">
        Re-roll failed invulnerable saves
      </label>
    </div>


    <h4>Damage</h4>

    <div class="form-group form-inline">
      <label class="radio-inline">
        <input type="radio" name="damage" id="damage-fixed" checked> Fixed amount:
      </label>
      <input class="form-control" type="number" id="damage-fixed-amount" min="1" max="6" value="1">
      <label class="radio-inline">
        <input type="radio" name="damage" id="damage-d3"> D3
      </label>
      <label class="radio-inline">
        <input type="radio" name="damage" id="damage-d6"> D6
      </label>
      <label class="radio-inline">
        <input type="radio" name="damage" id="damage-2d6"> 2D6
      </label>
    </div>

    <h4>Abilities</h4>

    <div class="form-group form-inline">
      <label class="checkbox-inline">
        <input type="checkbox" id="special-4"> Disgustingly resilient (4+)
      </label>
      <label class="checkbox-inline">
        <input type="checkbox" id="special-5"> Disgustingly resilient (5+)
      </label>
      <label class="checkbox-inline">
        <input type="checkbox" id="special-6"> Warlord (6+)
      </label>
    </div>

    <svg width="960" height="500"></svg>

    <script>
      var getprob = function(rollneeded, rerollall, rerollones) {
        var prob = (7 - rollneeded) / 6;
        if (rerollall) {
          prob = prob + (1 - prob) * prob;
        } else if (rerollones) {
          prob = prob + (1 / 6) * prob;
        }
        return prob;
      }

      var gethitprob = function(tohit, tohit_rerollall, tohit_rerollones) {
        return getprob(tohit, tohit_rerollall, tohit_rerollones);
      }

      var getwoundprob = function(strength, toughness, towound_rerollall,
                                  towound_rerollones) {
        var towound;
        if (strength >= 2 * toughness) {
          towound = 2;
        } else if (strength > toughness) {
          towound = 3;
        } else if (strength == toughness) {
          towound = 4;
        } else if (strength <= toughness / 2) {
          towound = 6;  // Out of order for predence over 5+
        } else if (strength < toughness) {
          towound = 5;
        }
        return getprob(towound, towound_rerollall, towound_rerollones);
      }

      var getInt = function(selector) {
        return parseInt($(selector).val(), 10);
      }
      var getBool = function(selector) {
        return $(selector).is(':checked');
      }

      function refreshdata() {

        var numattacks = getInt('#num-attacks');

        var tohit = getInt('#tohit');
        var tohit_rerollall = getBool('#tohit-mod-rerollall');
        var tohit_rerollones = getBool('#tohit-mod-rerollones');

        var strength = getInt('#strength');
        var toughness = getInt('#toughness');
        var towound_rerollall = getBool('#towound-mod-rerollall');
        var towound_rerollones = getBool('#towound-mod-rerollones');

        var armour = getInt('#armour');
        var ap = getInt('#ap');
        var invulnerable = getInt('#invulnerable');
        var invulnerable_rerollall = getBool('#invulnerable_rerollall');
        var invulnerable_rerollones = getBool('#invulnerable_rerollones');

        var damage_fixed = getBool('#damage-fixed');
        var damage_fixed_amount = getInt('#damage-fixed-amount');
        var damage_d3 = getBool('#damage-d3');
        var damage_d6 = getBool('#damage-d6');
        var damage_2d6 = getBool('#damage-2d6');

        var special_4 = getBool('#special-4');
        var special_5 = getBool('#special-5');
        var special_6 = getBool('#special-6');

        var hitprob = gethitprob(tohit, tohit_rerollall, tohit_rerollones);
        var woundprob = getwoundprob(strength, toughness, towound_rerollall,
                                     towound_rerollones);

        var finalprob = hitprob * woundprob;

        var data = [];
        for (i = 0; i <= numattacks; i++) {
          var frequency = jStat.binomial.pdf(i, numattacks, finalprob);
          data.push({ frequency: frequency, letter: i })
        }

        update(data);
      }

      var svg = d3.select("svg"),
          margin = {top: 20, right: 20, bottom: 30, left: 40},
          width = +svg.attr("width") - margin.left - margin.right,
          height = +svg.attr("height") - margin.top - margin.bottom;

      var x = d3.scaleBand().rangeRound([0, width]).padding(0.1),
          y = d3.scaleLinear().rangeRound([height, 0]);

      var xAxis = d3.axisBottom(x);

      var yAxis = d3.axisLeft(y).ticks(10, "%");

      var g = svg.append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      g.append("g")
          .attr("class", "axis axis--x")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);

      g.append("g")
          .attr("class", "axis axis--y")
          .call(yAxis)
        .append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", "0.71em")
          .attr("text-anchor", "end")
          .text("Frequency");

      function update(data) {
        x.domain(data.map(function(d) { return d.letter; }));
        y.domain([0, d3.max(data, function(d) { return d.frequency; })]);

        g.select('.axis.axis--x').transition().duration(300).call(xAxis);
        g.select(".axis.axis--y").transition().duration(300).call(yAxis);

        var bars = g.selectAll(".bar").data(data, function(d) {
            return d.letter;
        })

        // g.selectAll(".bar")
        //   .data(data)
        //   .enter().append("rect")
        //     .attr("class", "bar")
        //     .attr("x", function(d) { return x(d.letter); })
        //     .attr("y", function(d) { return y(d.frequency); })
        //     .attr("width", x.bandwidth())
        //     .attr("height", function(d) { return height - y(d.frequency); });

        // REMOVE
        bars.exit()
          .transition()
            .duration(300)
          .attr("y", y(0))
          .attr("height", height - y(0))
          .style('fill-opacity', 1e-6)
          .remove();

        // ENTER
        bars.enter().append("rect")
            .attr("class", "bar")
            .attr("y", y(0))
            .attr("height", height - y(0))
        // UPDATE + ENTER
          .merge(bars)
            .transition()
              .duration(300)
            .attr("x", function(d) { return x(d.letter); })
            .attr("width", x.bandwidth())
            .attr("y", function(d) { return y(d.frequency); })
            .attr("height", function(d) { return height - y(d.frequency); });
      }

      refreshdata();

      $('input, select').change(refreshdata);

    </script>
  </body>
</html>
